<!DOCTYPE html>
<html>
    <head>
        <title>User Settings</title>
        <link rel="stylesheet" href="static/stylesheets/normalize.css" />
        <link rel="stylesheet" href="static/stylesheets/main.css" />
        <script src="static/js/jquery.js"></script>
        <script src="settings.js"></script>
        <script type="text/javascript">
            var fs = require('fs');
            var exclude = null;
            $(document).ready(function() {
                var url = get_setting('url');
                if (url) $('#cloud-url').val(url);
                var token = get_setting('token');
                if (token) $('#token').val(token);
                var container = get_setting('container');
                if (container) $('#container').val(container);
                var directory = get_setting('directory');
                if (directory) $('#directory').html(directory);
                exclude = get_setting('exclude');
                if (exclude) $('#exclude').val(
                    fs.readFileSync(exclude, encoding='utf-8'));
                var weblogin = get_setting('weblogin');
                var pithos_url = get_setting('pithos_url');
                if (weblogin && pithos_url) {
                    $('#get_creds').show();
                } else {
                    console.log('No pithos view, remove credential button');
                    $('#get_creds').hide();
                }
            });

            function update_exclude(new_content) {
                if (exclude) fs.writeFile(exclude, new_content);
            }


            function extract_credentials(cookie) {
                var credentials = cookie.value.split('%7C');
                var uuid = credentials[0];
                var token = credentials[1];
                //$('#uuid').html(uuid);
                $('#token').val(token);
                $('#token').trigger('change');
                //set_setting('token', $(this).val())
            }

            var gui = require('nw.gui');
            function extract_cookie(url) {
                var cookie_name = '_pithos2_a';
                var w = gui.Window.open(url, {
                    focus: true, width: 520, height: 841
                });
                w.cookies.getAll({name: cookie_name}, function(cookies) {
                    if (cookies.length) {
                        console.log('Already logged in');
                        extract_credentials(cookies[0]);
                        w.close();
                    } else {
                        console.log('Not logged in');
                    }
                });
                w.cookies.onChanged.addListener(function(info) {
                    if (info.cookie.name === cookie_name) {
                        console.log('Succesfully logged in');
                        extract_credentials(info.cookie);
                        w.close();
                    }
                });
            }

            function get_credentials() {
                var weblogin = get_setting('weblogin')
                var pithos_url = get_setting('url');
                extract_cookie(weblogin + '?next=' + pithos_url);
            }
        </script>
    </head>
    <body>
        <div class="row js-main">
            <header>
            <h2>&nbsp;<img src="static/images/about.png" style="width: 16; height: 16;"/>&nbsp;User Settings</h2>
            </header>
            <form>
                <div class="row">
                    <div class="small-8 columns">
                        <fieldset>
                            <legend>Cloud</legend>
                            <div class="row error">
                                <div class="small-3 columns">
                                    <label for="cloud-url" class="right inline">Cloud URL</label>

                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="cloud-url" placeholder="Authentication URL"
                                    onchange="set_setting('url', $(this).val())">
                                    <small class="error" style="visibility: hidden">Invalid entry</small>
                                </div>
                            </div>

                            <div class="row error">
                                <div class="small-3 columns">
                                    <label for="token" class="right inline">User token</label>
                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="token" placeholder="User token"
                                    onchange="set_setting('token', $(this).val())">
                                    <small class="error" style="visibility: hidden">Invalid entry</small>
                                </div>
                             </div>

                            <div class="clearfix">
                               <a id="get_creds"
                                    class="button right" style="display: none;"
                                    onclick="get_credentials();">Get credentials</a>
                            </div>

                        </fieldset>
                        <fieldset>
                            <legend>What to sync</legend>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="container" class="right inline">Remote container</label>
                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="container" placeholder="Pithos+ container"
                                    onchange="set_setting('container', $(this).val())">
                                </div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="directory" class="right inline">Local directory</label>
                                </div>
                                <div class="small-9 columns" id="directory">
                                    No dir chosen</div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">Change it:</div>
                                <div class="small-9 columns">
                                    <!-- TODO: change the label of this field -->
                                    <input type="file" nwdirectory
                                    onchange="
                                        $('#directory').html($(this).val());
                                        set_setting('directory', $(this).val());
                                    " />
                                </div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="" class="right inline">Exclude these items from syncing</label>
                                </div>
                                <div class="small-9 columns">
                                    <textarea id="exclude"
                                        onchange="update_exclude($(this).val())">
                                    </textarea>
                                </div>
                            </div>
                        </fieldset>
                        <!--<div class="clearfix">
                            <a id="sync_button" class="button right"
                                onclick="window.close();">OK</a>
                        </div>   -->
                    </div>

                    <!--<div class="small-4 columns">
                        <p class="panel">I have no idea what will happen if I put my credentials there...<br>My space could be used to explain what is going on here.</p>
                    </div>-->

                    </div>
                </div>
            </form>
        </div>
    </body>
</html>
