<!DOCTYPE html>
<!-- Copyright (C) 2015 GRNET S.A.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>. -->
<html>
    <head>
        <title>User Settings</title>
        <link rel="stylesheet" href="static/stylesheets/normalize.css" />
        <link rel="stylesheet" href="static/stylesheets/main.css" />
        <script src="static/js/jquery.js"></script>
        <script src="settings.js"></script>
        <script type="text/javascript">
            var fs = require('fs');
            var exclude = null;
            remove_tokens = null;
            $(document).ready(function() {
                var url = get_setting('url');
                if (url) $('#cloud-url').val(url);
                var token = get_setting('token');
                if (token) $('#token').val(token);
                var container = get_setting('container');
                if (container) $('#container').val(container);
                var directory = get_setting('directory');
                if (directory) $('#directory').html(directory);
                var exclude = get_setting('exclude');
                if (exclude) try {
                        $('#exclude').val(
                            fs.readFileSync(exclude, encoding='utf-8'));
                } catch (err) {console.log(err);}
            });

            function update_exclude(new_content) {
                if (exclude) fs.writeFile(exclude, new_content);
            }


            function extract_credentials(cookie) {
                var credentials = cookie.value.split('%7C');
                var uuid = credentials[0];
                var token = credentials[1];
                //$('#uuid').html(uuid);
                $('#token').val(token);
                $('#token').trigger('change');
                //set_setting('token', $(this).val())
            }

            function remove_cookies(win, url) {
                var removed_at_least_one = false
                win.cookies.getAll({url: url}, function(cookies) {
                    $.each(cookies, function(i, cookie) {
                        win.cookies.remove({url: url, name: cookie.name} );
                        removed_at_least_one = true;
                    });
                });
                return removed_at_least_one;
            }

            var gui = require('nw.gui');
            var cred_win = null;
            var logout_win = null;
            var got_cookie = false;
            var show_creds = true;
            function get_credentials() {
                var cookie_name = '_pithos2_a';
                var lurl = get_account_ui() + '/logout?next=' + get_pithos_ui()

                show_creds = false;
                $('#get_creds').hide();

                got_cookie = false;
                cred_win = gui.Window.open(lurl, {
                    focus: true, width: 820, height: 580, toolbar: false
                });

                cred_win.cookies.onChanged.addListener(function(info) {
                    if (info.cookie.name === cookie_name) {
                        console.log('Succesfully logged in');
                        extract_credentials(info.cookie);
                        got_cookie = true;
                    }
                });
                cred_win.on('loaded', function() {
                    if (got_cookie) cred_win.close();
                });

                cred_win.on('closed', function() {
                    logout_win = gui.Window.open(
                        get_account_ui() + '/logout',
                        {focus: true, width:20, height: 20 });
                    logout_win.hide();
                    logout_win.on('loaded', function() {
                        while(remove_cookies(logout_win, get_pithos_ui())) {}
                        logout_win.close();
                        show_creds = true;
                    });
                });
            }

            window.setInterval(function() {
                // Refresh get_creds visibility, until refresh_endpoints
                // changes are in effect
                if (get_pithos_ui() && show_creds) {
                    $('#get_creds').show();
                } else {$('#get_creds').hide(); }
            }, 500);
        </script>
    </head>
    <body>
        <div class="row js-main">
            <header>
            <h2>&nbsp;<img src="static/images/about.png" style="width: 16; height: 16;"/>&nbsp;User Settings</h2>
            </header>
            <form>
                <div class="row">
                    <div class="small-8 columns">
                        <fieldset>
                            <legend>Cloud</legend>
                            <div class="row error">
                                <div class="small-3 columns">
                                    <label for="cloud-url" class="right inline">Cloud URL</label>

                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="cloud-url" placeholder="Authentication URL"
                                    onchange="set_setting('url', $(this).val()); refresh_endpoints($(this).val());">
                                    <small class="error" style="visibility: hidden">Invalid entry</small>
                                </div>
                            </div>

                            <div class="row error">
                                <div class="small-3 columns">
                                    <label for="token" class="right inline">User token</label>
                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="token" placeholder="User token"
                                    onchange="set_setting('token', $(this).val())">
                                    <small class="error" style="visibility: hidden">Invalid entry</small>
                                </div>
                             </div>

                            <div class="clearfix">
                               <a id="get_creds"
                                    class="button right" style="display: none;"
                                    onclick="get_credentials();">Login to get credentials</a>
                            </div>

                        </fieldset>
                        <fieldset>
                            <legend>What to sync</legend>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="container" class="right inline">Remote container</label>
                                </div>
                                <div class="small-9 columns">
                                    <input type="text" id="container" placeholder="Pithos+ container"
                                    onchange="set_setting('container', $(this).val())">
                                </div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="directory" class="right inline">Local directory</label>
                                </div>
                                <div class="small-9 columns" id="directory">
                                    No dir chosen</div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">Change it:</div>
                                <div class="small-9 columns">
                                    <!-- TODO: change the label of this field -->
                                    <input type="file" nwdirectory
                                    onchange="
                                        $('#directory').html($(this).val());
                                        set_setting('directory', $(this).val());
                                    " />
                                </div>
                            </div>
                            <div class="row">
                                <div class="small-3 columns">
                                    <label for="" class="right inline">Exclude these items from syncing</label>
                                </div>
                                <div class="small-9 columns">
                                    <textarea id="exclude"
                                        onchange="update_exclude($(this).val())">
                                    </textarea>
                                </div>
                            </div>
                        </fieldset>
                        <!--<div class="clearfix">
                            <a id="sync_button" class="button right"
                                onclick="window.close();">OK</a>
                        </div>   -->
                    </div>

                    <!--<div class="small-4 columns">
                        <p class="panel">I have no idea what will happen if I put my credentials there...<br>My space could be used to explain what is going on here.</p>
                    </div>-->

                    </div>
                </div>
            </form>
        </div>
    </body>
</html>
