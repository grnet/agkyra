<!DOCTYPE html>
<html>
<head><title>GUI for Agkyra Pithos+ Syncing Client</title></head>
<body>
    <script src="protocol.js"></script>
    <script src="settings.js"></script>
    <script type="text/javascript">

    // Setup GUI
var windows = {
  "settings": null,
  "about": null,
  "index": gui.Window.get()
}
function closeWindows() {
  for (win in windows) if (windows[win]) windows[win].close();
}

// GUI components
var tray = new gui.Tray({
  // tooltip: 'Paused (0% synced)',
  title: 'Agkyra syncs with Pithos+',
  icon: 'images/tray.png'
});

var menu = new gui.Menu();

// Progress and Pause
var start_syncing = 'Start Syncing';
var start_icon = 'images/play.png';
var pause_syncing = 'Pause Syncing';
var paused = true;

progress_item = new gui.MenuItem({
  // progress menu item
  label: 'Initializing',
  type: 'normal',
  enabled: false
});
menu.append(progress_item);
menu.append(new gui.MenuItem({type: 'separator'}));
pause_item = new gui.MenuItem({
  // pause menu item
  icon: 'images/play_pause.png',
  label: 'NOT READY',
  type: 'normal',
  click: function() {
    if (paused) {post_start(socket);} else {post_pause(socket);}
  }
});
pause_item.enabled = false;
menu.append(pause_item);

// Menu actions contents
var local_folder_menu = new gui.MenuItem({
  label: 'Open local folder',
  icon: 'images/folder.png',
  enabled: false,
  click: function () {
    var dir = globals['settings']['directory'];
    console.log('Open ' + dir);
    gui.Shell.showItemInFolder(dir);
  }
})
menu.append(local_folder_menu);

var pithos_page_menu = new gui.MenuItem({
  label: 'Launch Pithos+ page',
  icon: 'images/pithos.png',
  enabled: false,
  click: function () {
    var pithos_ui = globals['settings']['pithos_ui'];
    console.log('Visit ' + pithos_ui);
    gui.Shell.openExternal(pithos_ui);
  }
});
menu.append(pithos_page_menu);

// Settings and About
menu.append(new gui.MenuItem({type: 'separator'}));
var settings_menu = new gui.MenuItem({
  label: 'Settings',
  icon: 'images/settings.png',
  enabled: false,
  click: function () {
    export_settings(globals.settings);
    if (windows['settings']) windows['settings'].close();
    windows['settings'] = gui.Window.open("settings.html", {
      toolbar: false, focus: true,
      width: 841, height: 520
    });
    windows['settings'].on('closed', function() {
      new_settings = import_settings();
      console.log('Settings windows is closed, PUT');
      put_settings(socket, new_settings);
      get_settings(socket);
    });
  },
});
menu.append(settings_menu);

menu.append(new gui.MenuItem({
  label: 'About',
  icon: 'images/about.png',
  click: function () {
    if (windows['about']) windows['about'].close();
    windows['about'] = gui.Window.open("about.html", {
      toolbar: false, resizable: false, focus: true,
      width: 679, height: 420
    });
  }
}));

// Quit
menu.append(new gui.MenuItem({type: 'separator'}));
menu.append(new gui.MenuItem({
  label: 'Quit Agkyra',
  icon: 'images/exit.png',
  click: function() {post_shutdown(socket);}
}));


// Update progress
var client_ready = false;
window.setInterval(function() {
  if (!client_ready) {
    if (globals.authenticated) {
      settings_menu.enabled = true;
      client_ready = true;
    } else return;
  }

  if (client_ready) {
    if (!pithos_page_menu.enabled) {
      // GET pithos page with tokenless operations
    }
    if (!local_folder_menu.enabled) {
      if (globals.settings.directory) {
        local_folder_menu.enabled = true;
      }
    }
  }

  var status = globals['status'];
  var new_progress = progress_item.label;
  var new_pause = pause_item.label;
  var menu_modified = false;
  if (status['paused'] !== null) {
    switch(pause_item.label) {
      case pause_syncing: if (status['paused']) {
          // Update to "Paused - start syncing"
          paused = true;
          new_pause = start_syncing;
          menu_modified = true;
        } // else continue syncing
        new_progress = status['progress'] + '%' + ' synced';
      break;
      case start_syncing: if (status['paused']) return;
        // else update to "Syncing - pause syncing"
        paused = false;
        new_pause = pause_syncing;
        new_progress = status['progress'] + '%' + ' synced';
        menu_modified = true;
      break;
      default:
        if (status['paused']) {new_pause = start_syncing; paused=true;}
        else {new_pause = pause_syncing; paused=false;}
        new_progress = status['progress'] + '%' + ' synced';
        pause_item.enabled = true;
        menu_modified = true;
    }
  }
  if (new_pause != pause_item.label) {
    pause_item.label = new_pause;
    menu_modified = true;
  }
  if (new_progress != progress_item.label) {
    progress_item.label = new_progress;
    menu_modified = true;
  }
  if (menu_modified) {
    if (paused) progress_item.label += ' - paused';
    tray.menu = menu;
  }
  get_status(socket);
}, 1500);

tray.menu = menu;

    </script>
</body>
</html>