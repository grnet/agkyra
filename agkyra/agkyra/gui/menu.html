<!DOCTYPE html>
<html>
<head><title>GUI for Agkyra Pithos+ Syncing Client</title></head>
<body>
    <script src="protocol.js"></script>
    <script src="settings.js"></script>
    <script src="static/js/jquery.js"></script>
    <script type="text/javascript">

var DEBUG = true;

// Setup GUI
var windows = {
  "settings": null,
  "about": null,
  "index": gui.Window.get()
}
function closeWindows() {
  for (win in windows) if (windows[win]) windows[win].close();
}

// GUI components
var tray = new gui.Tray({
  title: 'Agkyra syncs with Pithos+',
  icon: 'images/tray.png'
});

var menu = new gui.Menu();

// Progress and Pause
var start_syncing = 'Start Syncing';
var start_icon = 'images/play.png';
var pause_syncing = 'Pause Syncing';
var paused = true;

progress_item = new gui.MenuItem({
  // progress menu item
  label: 'Initializing',
  type: 'normal',
  enabled: false
});
menu.append(progress_item);
menu.append(new gui.MenuItem({type: 'separator'}));
pause_item = new gui.MenuItem({
  // pause menu item
  icon: 'images/play_pause.png',
  label: 'NOT READY',
  type: 'normal',
  click: function() {
    if (paused) {post_start(socket);} else {post_pause(socket);}
  }
});
pause_item.enabled = false;
menu.append(pause_item);

// Menu actions contents
var local_folder_menu = new gui.MenuItem({
  label: 'Open local folder',
  icon: 'images/folder.png',
  enabled: false,
  click: function () {
    var dir = globals['settings']['directory'];
    if (DEBUG) console.log('Open ' + dir);
    gui.Shell.showItemInFolder(dir);
  }
})
menu.append(local_folder_menu);

var pithos_page_menu = new gui.MenuItem({
  label: 'Launch Pithos+ page',
  icon: 'images/pithos.png',
  enabled: false,
  click: function () {
    if (DEBUG) console.log('Visit ' + get_pithos_ui());
    gui.Shell.openExternal(get_pithos_ui());
  }
});
menu.append(pithos_page_menu);

// Settings and About
menu.append(new gui.MenuItem({type: 'separator'}));
var settings_menu = new gui.MenuItem({
  label: 'Settings',
  icon: 'images/settings.png',
  enabled: false,
  click: function () {
    export_settings(globals.settings);
    if (windows['settings']) windows['settings'].close();
    var old_settings = {};
    $.each(globals.settings, function(key, val) {old_settings[key]=val;});
    windows['settings'] = gui.Window.open("settings.html", {
      toolbar: false, focus: true,
      width: 841, height: 520
    });
    windows['settings'].on('closed', function() {
      if (DEBUG) console.log('Settings windows is closed');
      var new_settings = import_settings();
      $.each(new_settings, function(key, setting) {
        if (old_settings[key] !== setting) {
          if (DEBUG) console.log('Settings have been modified - updating...');
          put_settings(socket, new_settings);
          get_status(socket);
          get_settings(socket);
          return false;
        }
      });
    });
  },
});
menu.append(settings_menu);

menu.append(new gui.MenuItem({
  label: 'About',
  icon: 'images/about.png',
  click: function () {
    if (windows['about']) windows['about'].close();
    windows['about'] = gui.Window.open("about.html", {
      toolbar: false, resizable: false, focus: true,
      width: 679, height: 420
    });
  }
}));

// Quit
menu.append(new gui.MenuItem({type: 'separator'}));
menu.append(new gui.MenuItem({
  label: 'Quit Agkyra',
  icon: 'images/exit.png',
  click: function() {post_shutdown(socket);}
}));


// Update progress
var client_ready = false;
window.setInterval(function() {
  if (globals.open_settings) {
    globals.open_settings = false;
    settings_menu.click();
  }

  var menu_modified = false;
  if (!client_ready) {
    if (!globals.authenticated) return;
    client_ready = true;
  }

  if (client_ready) {
    if (!settings_menu.enabled) {
      if (globals.settings.url) refresh_endpoints(globals.settings.url);
      settings_menu.enabled = true;
      tray.menu = menu;
    }
    if (globals.settings.url && !pithos_page_menu.enabled) {
      if (get_pithos_ui() != null) {
        pithos_page_menu.enabled = true;
        tray.menu = menu;
      } else { refresh_endpoints(globals.settings.url); }
    }
    if (!local_folder_menu.enabled) {
      if (globals.settings.directory) {
        local_folder_menu.enabled = true;
        tray.menu = menu;
      }
    }
  }

  var status = globals['status'];
  var new_progress = progress_item.label;
  var new_pause = pause_item.label;
  if (!status.can_sync) {
    new_progress = 'Incomplete settings'
    new_pause = 'inactive'
    pause_item.enabled = false;
  } else {
    if (status.paused !== null) {
      switch(pause_item.label) {
        case pause_syncing: if (status.paused) {
            // Update to "Paused - start syncing"
            paused = true;
            new_pause = start_syncing;
            menu_modified = true;
          } // else continue syncing
        break;
        case start_syncing: if (!status.paused) {
            //update to "Syncing - pause syncing"
            paused = false;
            new_pause = pause_syncing;
            menu_modified = true;
          }
        break;
        default:
          if (status.paused) {new_pause = start_syncing; paused=true;}
          else {new_pause = pause_syncing; paused=false;}
          pause_item.enabled = true;
          menu_modified = true;
      }
    }
    new_progress = status.synced + ' of ' + status.unsynced + ' synced';
  }
  if (new_pause != pause_item.label) {
    pause_item.label = new_pause;
    menu_modified = true;
  }
  if (new_progress != progress_item.label) {
    progress_item.label = new_progress;
    menu_modified = true;
  }
  if (menu_modified) {
    if (paused) progress_item.label += ' - paused';
    tray.menu = menu;
  }
  get_status(socket);
}, 1500);

tray.menu = menu;

    </script>
</body>
</html>