<!DOCTYPE html>
<!--
Copyright (C) 2015 GRNET S.A.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head><title>GUI for Agkyra Pithos+ Syncing Client</title></head>
<body>
    <script src="protocol.js"></script>
    <script src="settings.js"></script>
    <script src="static/js/jquery.js"></script>
    <script type="text/javascript">

// Setup GUI
var windows = {
  "settings": null,
  "about": null,
  "index": gui.Window.get()
}
function closeWindows() {
  for (win in windows) if (windows[win]) windows[win].close();
}

// GUI components
var tray = new gui.Tray({
  title: 'Agkyra syncs with Pithos+',
  icon: 'static/images/tray.png'
});

var menu = new gui.Menu();

// Progress and Pause
var start_syncing = 'Start Syncing';
var pause_syncing = 'Pause Syncing';
var paused = true;

progress_item = new gui.MenuItem({
  // progress menu item
  label: 'Initializing',
  type: 'normal',
  enabled: false
});
menu.append(progress_item);
menu.append(new gui.MenuItem({type: 'separator'}));
pause_item = new gui.MenuItem({
  // pause menu item
  icon: 'static/images/play_pause.png',
  label: 'NOT READY',
  type: 'normal',
  click: function() {
    if (paused) {post_start(socket);} else {post_pause(socket);}
  }
});
pause_item.enabled = false;
menu.append(pause_item);

// Menu actions contents
var local_folder_menu = new gui.MenuItem({
  label: 'Open local folder',
  icon: 'static/images/folder.png',
  enabled: false,
  click: function () {
    var dir = globals['settings']['directory'];
    log_debug('Open ' + dir);
    gui.Shell.showItemInFolder(dir + path.sep + '.');
  }
})
menu.append(local_folder_menu);

var pithos_page_menu = new gui.MenuItem({
  label: 'Launch Pithos+ page',
  icon: 'static/images/pithos.png',
  enabled: false,
  click: function () {
    log_debug('Visit ' + get_pithos_ui());
    gui.Shell.openExternal(get_pithos_ui());
  }
});
menu.append(pithos_page_menu);

// Settings and About
menu.append(new gui.MenuItem({type: 'separator'}));
var settings_menu = new gui.MenuItem({
  label: 'Settings',
  icon: 'static/images/settings.png',
  enabled: false,
  click: function () {
    globals.settings_are_open = true;
    globals.open_settings = false;
    export_settings(globals.settings);
    if (windows['settings']) windows['settings'].close();
    var old_settings = {};
    $.each(globals.settings, function(key, val) {old_settings[key]=val;});
    windows['settings'] = gui.Window.open("settings.html", {
      toolbar: false, focus: true,
      width: 860, height: 620
    });
    windows['settings'].on('closed', function() {
      log_debug('Settings windows is closed');
    globals.settings_are_open = false;
      var new_settings = import_settings();
      $.each(new_settings, function(key, setting) {
        log_debug('Compare ' + old_settings[key] + ' with ' + setting);
        if (old_settings[key] !== setting) {
          log_debug('Settings have been modified - updating...');
          put_settings(socket, new_settings);
          get_status(socket);
          get_settings(socket);
          return false;
        }
      });
    });
  },
});
menu.append(settings_menu);

menu.append(new gui.MenuItem({
  label: 'About',
  icon: 'static/images/about.png',
  click: function () {
    if (windows['about']) windows['about'].close();
    windows['about'] = gui.Window.open("about.html", {
      toolbar: false, resizable: false, focus: true,
      width: 860, height: 620
    });
  }
}));

// Quit
menu.append(new gui.MenuItem({type: 'separator'}));
menu.append(new gui.MenuItem({
  label: 'Quit Agkyra',
  icon: 'static/images/exit.png',
  click: function() {post_shutdown(socket);}
}));


function deactivate_menu() {
  if (
      pause_item.enabled ||
      local_folder_menu.enabled ||
      pithos_page_menu.enabled) {
    progress_item.label = 'Settings window is open';
    pause_item.enabled = false;
    local_folder_menu.enabled = false;
    pithos_page_menu.enabled = false;
    tray.menu = menu;
  }
}


// Update progress
var client_ready = false;
window.setInterval(function() {
  if (globals.settings_are_open) {
    deactivate_menu();
    return;
  }

  if (globals.open_settings) {
    globals.open_settings = false;
    settings_menu.click();
    deactivate_menu();
    return;
  }

  var menu_modified = false;
  if (!client_ready) {
    if (!globals.authenticated) return;
    client_ready = true;
  }

  if (client_ready) {
    pause_item.enabled = (pause_item.label !== 'inactive');
    if (!settings_menu.enabled) {
      if (globals.settings.url) refresh_endpoints(globals.settings.url);
      settings_menu.enabled = true;
      tray.menu = menu;
    }
    if (globals.settings.url && !pithos_page_menu.enabled) {
      if (get_pithos_ui() != null) {
        pithos_page_menu.enabled = true;
        tray.menu = menu;
      } else { refresh_endpoints(globals.settings.url); }
    }
    if (!local_folder_menu.enabled) {
      if (globals.settings.directory) {
        local_folder_menu.enabled = true;
        tray.menu = menu;
      }
    }
  }

  var status = globals['status'];
  var new_progress = progress_item.label;
  var new_pause = pause_item.label;
  if (!status.can_sync) {
    if (globals.just_opened) new_progress = 'Connecting...'
    else new_progress = 'Not able to sync'
    new_pause = 'inactive'
    pause_item.enabled = false;
  } else {
    if (status.paused !== null) {
      switch(pause_item.label) {
        case pause_syncing: if (status.paused) {
            // Update to "Paused - start syncing"
            paused = true;
            new_pause = start_syncing;
            menu_modified = true;
          } // else continue syncing
        break;
        case start_syncing: if (!status.paused) {
            //update to "Syncing - pause syncing"
            paused = false;
            new_pause = pause_syncing;
            menu_modified = true;
          }
        break;
        default:
          if (status.paused) {new_pause = start_syncing; paused=true;}
          else {new_pause = pause_syncing; paused=false;}
          pause_item.enabled = true;
          menu_modified = true;
      }
    }

    var remaining = status.unsynced - status.synced;
    if (status.paused){
      if (remaining)
        new_progress = 'Pausing, ' + remaining + ' remaining';
      else new_progress = 'Paused';
    } else {
      if (remaining)
        new_progress = 'Syncing, ' + remaining + ' remaining';
      else new_progress = 'Running, all synced';
    }
  }
  if (new_pause !== pause_item.label.slice(0, new_pause.length)) {
    pause_item.label = new_pause;
    menu_modified = true;
  }
  if (new_progress !== progress_item.label) {
    progress_item.label = new_progress;
    menu_modified = true;
  }
  if (menu_modified) tray.menu = menu;
  get_status(socket);
}, 1500);

tray.menu = menu;

    </script>
</body>
</html>