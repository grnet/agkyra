<!DOCTYPE html>
<!--
Copyright (C) 2015 GRNET S.A.

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
-->
<html>
<head>
  <meta charset="UTF-8" />
  <title>GUI for Agkyra Pithos+ Syncing Client</title>
</head>
<body>
    <script src="protocol.js"></script>
    <script src="settings.js"></script>
    <script src="notify.js"></script>
    <script src="static/js/jquery.js"></script>
    <script type="text/javascript">

// Setup GUI
var windows = {
  "settings": null,
  "about": null,
  "index": gui.Window.get()
}
function closeWindows() {
  for (win in windows) if (windows[win]) windows[win].close();
}

// GUI components
var tray = new gui.Tray({
  tooltip: 'Agkyra Syncing Client',
  icon: 'static/images/tray.png',
  iconsAreTemplates: false
});

var menu = new gui.Menu();

// Progress and Pause
var start_syncing = 'Start Syncing';
var pause_syncing = 'Pause Syncing';
var paused = true;

progress_item = new gui.MenuItem({
  // progress menu item
  label: 'Initializing',
  type: 'normal',
  enabled: false
});
menu.append(progress_item);
menu.append(new gui.MenuItem({type: 'separator'}));
pause_item = new gui.MenuItem({
  // pause menu item
  icon: 'static/images/play_pause.png',
  iconIsTemplate: false,
  label: 'NOT READY',
  type: 'normal',
  click: function() {
    if (globals.status.code == STATUS['PAUSED']) post_start(socket);
    else if (globals.status.code == STATUS['SYNCING']) post_pause(socket);
    else log_debug('Illegal click - status code is ' + globals.status.code);
  }
});
pause_item.enabled = false;
menu.append(pause_item);

// Menu actions contents
var local_folder_menu = new gui.MenuItem({
  label: 'Open local folder',
  icon: 'static/images/folder.png',
  iconIsTemplate: false,
  enabled: false,
  click: function () {
    var dir = globals['settings']['directory'];
    log_debug('Open ' + dir);
    gui.Shell.showItemInFolder(dir + path.sep + '.');
  }
})
menu.append(local_folder_menu);

var pithos_page_menu = new gui.MenuItem({
  label: 'Launch Pithos+ page',
  icon: 'static/images/pithos.png',
  iconIsTemplate: false,
  enabled: false,
  click: function () {
    log_debug('Visit ' + get_pithos_ui());
    gui.Shell.openExternal(get_pithos_ui());
  }
});
menu.append(pithos_page_menu);

// Settings and About
menu.append(new gui.MenuItem({type: 'separator'}));
var settings_menu = new gui.MenuItem({
  label: 'Settings',
  icon: 'static/images/settings.png',
  iconIsTemplate: false,
  enabled: false,
  //kiosk: false,
  click: function () {
    globals.settings_are_open = true;
    globals.open_settings = false;
    export_settings(globals.settings);
    if (windows['settings']) windows['settings'].close();
    var old_settings = {};
    $.each(globals.settings, function(key, val) {old_settings[key]=val;});
    windows['settings'] = gui.Window.open("settings.html", {
      toolbar: false, focus: true,
      width: 860, height: 620
    });
    windows['settings'].on('closed', function() {
      log_debug('Settings windows is closed');
    globals.settings_are_open = false;
      var new_settings = import_settings();
      $.each(new_settings, function(key, setting) {
        log_debug('Compare ' + old_settings[key] + ' with ' + setting);
        if (old_settings[key] !== setting) {
          log_debug('Settings have been modified - updating...');
          put_settings(socket, new_settings);
          get_status(socket);
          get_settings(socket);
          return false;
        }
      });
    });
  },
});
menu.append(settings_menu);

menu.append(new gui.MenuItem({
  label: 'About',
  icon: 'static/images/about.png',
  iconIsTemplate: false,
  click: function () {
    if (windows['about']) windows['about'].close();
    windows['about'] = gui.Window.open("about.html", {
      toolbar: false, resizable: false, focus: true,
      width: 860, height: 620
    });
  }
}));

// Quit
menu.append(new gui.MenuItem({type: 'separator'}));
menu.append(new gui.MenuItem({
  label: 'Quit Agkyra',
  icon: 'static/images/exit.png',
  iconIsTemplate: false,
  click: function() {post_shutdown(socket);}
}));


function activate_menu() {
  if (!pause_item.enabled) pause_item.enabled = true;
  if (!settings_menu.enabled) {
    if (globals.settings.url) refresh_endpoints(globals.settings.url);
    settings_menu.enabled = true;
    tray.menu = menu;
  }
  if ((!pithos_page_menu.enabled) && get_pithos_ui() != null){
    pithos_page_menu.enabled = true;
    tray.menu = menu;
  }
  if ((!local_folder_menu.enabled) && globals.settings.directory) {
    local_folder_menu.enabled = true;
    tray.menu = menu;
  }
}

function deactivate_menu() {
  if (
      pause_item.enabled ||
      local_folder_menu.enabled ||
      pithos_page_menu.enabled) {
    pause_item.enabled = false;
    local_folder_menu.enabled = false;
    pithos_page_menu.enabled = false;
    tray.menu = menu;
  }
}

// Update progress
window.setInterval(function() {
  var new_progress = notification[globals.status.code];
  var new_pause = '';
  switch(globals.status.code) {
    case STATUS['UNINITIALIZED']:
    case STATUS['INITIALIZING']:
    case STATUS['SHUTING DOWN']:
      deactivate_menu();
      new_pause = 'inactive';
    break;
    case STATUS['SYNCING']:
      activate_menu();
      new_progress += ', ' + remaining(globals.status) + ' remaining';
      new_pause = 'Pause'
    break;
    case STATUS['PAUSING']:
      new_progress += ', ' + remaining(globals.status) + ' remaining';
      new_pause = 'waiting...'
      pause_item.enabled = false;
    break;
    case STATUS['PAUSED']:
      activate_menu();
      new_pause = 'Start syncing';
      if (remaining(globals.status) > 0)
        new_progress += ', ' + remaining(globals.status) + ' remaining';
    break;
    case STATUS['SETTINGS MISSING']:
    case STATUS['AUTH URL ERROR']:
    case STATUS['TOKEN ERROR']:
    case STATUS['DIRECTORY ERROR']:
    case STATUS['CONTAINER ERROR']:
      deactivate_menu();
      new_pause = 'inactive';
      settings_menu.enabled = true;
    break;
  }

  if (globals.open_settings) {
    new_progress = 'Settings window is open';
    globals.open_settings = false;
    settings_menu.click();
    deactivate_menu();
  } else if (globals.settings_are_open) deactivate_menu();

  if (new_progress !== progress_item.label
  ||  new_pause !== pause_item.label) {
    progress_item.label = new_progress;
    pause_item.label = new_pause;
    tray.menu = menu;
  }
  get_status(socket);
}, 1500);

tray.menu = menu;

    </script>
</body>
</html>
